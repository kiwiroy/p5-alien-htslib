# -*- mode: perl; -*-
use strict;
use warnings;
use alienfile;
use Path::Tiny qw{path};

our $htslib_version = '1.8';

plugin 'PkgConfig' => (
  pkg_name => 'htslib',
);

share {
  requires 'Alien::curl'   => '0.06';
  requires 'Alien::libdeflate' => '0.01';
  requires 'Alien::Libbz2' => '0.22';
  requires 'Alien::xz'     => '0.07';

  start_url "https://github.com/samtools/htslib/releases/download/${htslib_version}/htslib-${htslib_version}.tar.bz2";

  plugin Download => ( version => qr/([0-9\.]+)/, bootstrap_ssl => 1 );

  plugin Extract => ( format => 'tar.bz2' );

  plugin 'Build::Autoconf' => ( with_pic => 0 ); ## --with-pic creates configure warning.

  meta->interpolator->add_helper(libdeflate_cflags => sub {
    return Alien::libdeflate->cflags;
  });
  meta->interpolator->add_helper(libdeflate_libs => sub {
    return Alien::libdeflate->libs;
  });

  build [
    '%{configure} --enable-s3 --enable-libcurl --enable-gcs --with-libdeflate CFLAGS="-fPIC %{libdeflate_cflags}" LDFLAGS="%{libdeflate_libs}"',
    '%{make}',
    '%{make} install'
  ];

  after gather => sub {
    my ($build) = @_;

    my ($stage) = path('.')->absolute->child('lib');
    my @dynamic;
    ## we use the static library only, remove any dynamic libs
    push @dynamic, glob "$stage/*.dylib";
    push @dynamic, glob "$stage/*.so";
    push @dynamic, glob "$stage/*.so.*";
    push @dynamic, glob "$stage/*.dll";
    unlink @dynamic if @dynamic;

    my @aliens = qw{Alien::curl Alien::Libbz2 Alien::xz Alien::libdeflate};
    my $is_share = sub {
      $_->install_type eq 'share' && $_->can('cflags_static')
    };
    for my $key (qw{libs libs_static}) {
        $build->runtime_prop->{$key} =
            join(' ',
                 $build->runtime_prop->{$key},
                 ($build->runtime_prop->{$key} !~ m/\-lcurl/ ? '-lcurl' : ''),
                 map { $_->$key() } grep { $is_share->() } @aliens
                 );
    }

  };

  test [ '%{make} check' ] unless $ENV{ALIEN_HTSLIB_NO_CHECK};

};
